<!DOCTYPE html>

<html>	
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<!--[if lt IE 9]>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/aight/1.2.2/aight.min.js"></script>
	<![endif]-->
</head>
<style>

text {
  font: 10px sans-serif;
}

.chart rect {
  fill: steelblue;
}

.chart text {
  fill: white;
  font: 10px sans-serif;
  text-anchor: end;
}


/*********************/
@import url(http://fonts.googleapis.com/css?family=Open+Sans);

body { 
  font-family: 'Open Sans', sans-serif;
  color: #666;
}

body h1 {
	font-size: 1em;
}

body p {
	font-size: 0.75em;
}

/* STRUCTURE */

#pagewrap {
	padding: 5px;
	width: 1100px;
	margin: 20px auto;
}
#header {
	/*height: 100px;*/
	padding: 0 15px;
}
#leftCol {
	width: 290px;
	float: left;
	padding: 5px 15px;
}

#centerCol {
	width: 484px; /* Account for margins + border values */
	float: left;
	padding: 5px 15px;
	margin: 0px 5px 5px 5px;
}

#rightCol {
	width: 220px;
	padding: 5px 15px;
	float: left;
}
#footer {
	clear: both;
	padding: 0 15px;
}

/************************************************************************************
MEDIA QUERIES
*************************************************************************************/
/* for 980px or less */
@media screen and (max-width: 980px) {
	
	#pagewrap {
		width: 94%;
	}
	#content {
		width: 41%;
		padding: 1% 4%;
	}
	#middle {
		width: 41%;
		padding: 1% 4%;
		margin: 0px 0px 5px 5px;
		float: right;
	}
	
	#sidebar {
		clear: both;
		padding: 1% 4%;
		width: auto;
		float: none;
	}

	#header, #footer {
		padding: 1% 4%;
	}
}

/* for 700px or less */
@media screen and (max-width: 600px) {

	#content {
		width: auto;
		float: none;
	}
	
	#middle {
		width: auto;
		float: none;
		margin-left: 0px;
	}
	
	#sidebar {
		width: auto;
		float: none;
	}

}

/* for 480px or less */
@media screen and (max-width: 480px) {

	#header {
		height: auto;
	}
	h1 {
		font-size: 2em;
	}
	#sidebar {
		display: none;
	}

}


#content {
	background: #f8f8f8;
}
#sidebar {
	background: #f0efef;
}
#header, #content, #middle, #sidebar {
	margin-bottom: 5px;
}

#pagewrap, #header, #content, #middle, #sidebar, #footer {
	border: solid 1px #ccc;
}
/*********************/
	

</style>
<body>
	<div id="pagewrap">
		<div id="header">
			<p style="font-size: 50px;">Rolling Stone Top 100 Artists - Lyric Analysis</p>
			<p>
			After seeing this <a href="http://rappers.mdaniels.com.s3-website-us-east-1.amazonaws.com/"> analysis of the lyrics used by hip hop artists</a>, 
			I was curious to see how these numbers stacked up with other artist in other genres. So this is what I've got so far ...
			</p>
			<p>
			Rolling Stone Magazine have compiled a list of their <a href="http://www.rollingstone.com/music/lists/100-greatest-artists-of-all-time-19691231">top 100 musical artists of all time</a>.
			I figure that's probably a pretty good place to start, it's an interesting list with a wide range of artists and some of the entries make for good reading.
			</p>
			<p>
			Using that list as a base I pulled in a list of all the albums and songs in those albums for each of those artists from 
			<a href="http://lyrics.wikia.com/">LyricWikia</a>, the <a href="http://api.wikia.com/wiki/LyricWiki_API">API</a> 
			worked like it said on the box, really usable. I wasn't able to collect a discogrpahy for all the artists but I got most of them
			(I'm pretty sure that was more to do with the way I was using the API data than with the API itself).
			</p>
			<p>
			With the complete dicography for most of the artists in Rolling Stone's list, I then went on to collect the lyrics for those songs
			from <a href="http://www.chartlyrics.com/">Chartlyrics</a> (I would encourage you to consider contributing to their free community).
			They do have an API which worked OK for individaul queries, but appeared to be rate limited to 1 request every 20 seconds. 
			I ended up just scraping the lyrics web pages html for the songs I could find. I couldn't get all the songs for all the artist but I 
			got enough to work from. I exlcuded compilation albums and "featuring" appearances, and only stored one copy of each song regardless
			of how many times it appears in the discography.
			</p>
			<p>
			Below is a visualisation of the lyrics I collected. I've filtered out the artist where I collected less than 10,000 words. Click an artist lexical density
			bar on the left and a bubble chart with that artist's top N words is presented, N can be adjusted to show more or less words. 
			The right set of bars shows the number of times each word appears when the top 100 words for all artists are combined. The bar colour 
			changes to match the colour of the word in the bubble chart.
			</p>
			<p>
			<a href="http://en.wikipedia.org/wiki/Lexical_density">Lexical Density</a> seems like a reasonably good indicator of the vocabulary
			used by each artist, it differs from the measure use in the orignal hip hop analysis but I think it allows for a good comparison between 
			these various artists. As a point of reference with the hip hop data, Ice T, pretty much in the middle of the pack, has a lexical 
			density of (4431/35000)*100 = 12.66%. The lowset entry is DMX at 9.18%, and the highest Aesop Rock at a whopping 21.12%.
			</p>
			<p>
			So that's what I've got at the moment, it's a work in progress and I've got a few more ideas about what I can do with this set of data.
			I'll see where it goes next.
			</p>
			<p>
			(Note: Tool and NOFX do not appear in Rolling Stone's list, they were used in some early test cases 
			for the lyric collection process and I've decided to keep them in there)
			</p>
		</div>
		<div id="leftCol" class="column">
			<h1>Artist Lexical Density</h1>
			<p>Click an Artist</p>
		</div>
		<div id="centerCol" class="column">
			<h1 id="selectArtistTitle">Top N Words For Selected Artist</h1>
			<p>N = <input id="nWords" type="text" value="10" size="4" onchange="updateTopWordsArtist()"></input>(max 100)</p>
		</div>
		<div id="rightCol" class="column">
			<h1>All Artist Combined Top Words</h1>
		</div>
		<div id="footer"></div>
	</div>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="ratios.js"></script>
	
	<script>
	function getStyle(oElm, strCssRule){
		var strValue = "";
		if(document.defaultView && document.defaultView.getComputedStyle){
			strValue = document.defaultView.getComputedStyle(oElm, "").getPropertyValue(strCssRule);
		}
		else if(oElm.currentStyle){
			strCssRule = strCssRule.replace(/\-(\w)/g, function (strMatch, p1){
				return p1.toUpperCase();
			});
			strValue = oElm.currentStyle[strCssRule];
		}
		return strValue;
	}
	
	///////////////////////////////////////////////////////////////////////////
	// start at the top of the list ...
	var selectedArtistName = "The Velvet Underground";
	var width = document.getElementById("leftCol").offsetWidth,
		barHeight = 11,
		format = d3.format(",d"),
		color = d3.scale.category20c();
	
	width -= parseInt(getStyle(document.getElementById("leftCol"), "padding-right"));
	width -= parseInt(getStyle(document.getElementById("leftCol"), "padding-right"));
	
	var x = d3.scale.linear()
		.range([0, width]);

	var chart = d3.select("#leftCol").append("svg")
		.attr("width", width)
		.attr("class", "chart");;
	
	var artistStats = artistStats(ratios);
	
	x.domain([0, d3.max(artistStats, function(d) { return d.value; })]);
	
	chart.attr("height", barHeight * artistStats.length);
	
	var bar = chart.selectAll("g")
		.data(artistStats)
		.enter().append("g")
		.attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });
	
	bar.append("rect")
		.attr("width", function(d) { return x(d.value); })
		.attr("height", barHeight - 1)
		.on("click", function(d) {
						selectedArtistName = d.artistName;
						updateTopWordsArtist();});
	
	bar.append("text")
		.attr("x", function(d) { return x(d.value) - 3; })
		.attr("y", barHeight / 2)
		.attr("dy", ".35em")
		.text(function(d) { return d.artistName + ": " + (d.value*100).toFixed(2) + "%"; })
		.on("click", function(d) {
						selectedArtistName = d.artistName;
						updateTopWordsArtist();});
	
	// Returns a flattened hierarchy containing all leaf nodes under the root.
	function artistStats(root) {
		var classes = [];
		
		for (var i = 0; i < root.length; i++) {
			classes.push({_id: root[i]._id,
							artistName:root[i].value.artistName, 
							ratio: root[i].value.ratio,
							uniqueWordCount: root[i].value.uniqueWordCount,
							totalWordCount: root[i].value.totalWordCount,
							value: root[i].value.ratio});
							//value: 50});
		}
		classes.sort(function(a, b) { return b["ratio"] - a["ratio"]; });
		return classes;
	}
	
	//d3.select(self.frameElement).style("height", diameter + "px");
	///////////////////////////////////////////////////////////////////////////
	</script>
	
	<script>
	///////////////////////////////////////////////////////////////////////////
	var diameter2 = document.getElementById("centerCol").offsetWidth,
		format2 = d3.format(",d"),
		color2 = d3.scale.category20c();
		
	diameter2 -= parseInt(getStyle(document.getElementById("centerCol"), "padding-right"));
	diameter2 -= parseInt(getStyle(document.getElementById("centerCol"), "padding-left"));
	
	var svg2 = d3.select("#centerCol").append("svg")
		.attr("width", diameter2)
		.attr("height", diameter2)
		.attr("class", "bubble");
	
	function updateTopWordsArtist() {
		var nWords = parseInt(document.getElementById("nWords").value, 10);
		var bubble2 = d3.layout.pack()
			.sort(function(a, b) { return a.count > b.count; } )
			.size([diameter2, diameter2])
			.padding(1);
		
		document.getElementById("selectArtistTitle").innerHTML = "Top N Words For " + selectedArtistName;
		var topWords = artistTopWords(selectedArtistName, top100Words, nWords);
		
		updateAllTopWords(topWords);
		
		var node2 = svg2.selectAll(".node")
			.data(bubble2.nodes(topWords)
					.filter(function(d, i) { return !d.children; }),
				function(d) {return d.word} // key data based on className to keep object constancy
			);
		
		// capture the enter selection
		var nodeEnter = node2.enter()
			.append("g")
			.attr("class", "node")
			.attr("transform", function (d) {
				return "translate(" + 10 + "," + d.y + ")";
			});
		
		// re-use enter selection for circles
		nodeEnter
			.append("circle")
			.attr("r", function (d) {return 0;})
			.style("fill", function (d) {return color2(d.word);});
		
		// re-use enter selection for titles
		nodeEnter
			.append("title")
			.text(function (d) {
				return d.word + ": " + format(d.count);
			});
		
		nodeEnter
			.append("text")
			.attr("dy", ".3em")
			.style("text-anchor", "middle")
			.text(function(d) { return d.word + ": " + d.count; });
		
		node2
			.append("title")
			.text(function (d) {
				return d.word + ": " + format(d.count);
			});
		
		node2.select("text")
			.text(function(d) { return d.word + ": " + d.count; });
			
		node2.select("title")
			.text(function (d) {
				return d.word + ": " + format(d.count);
			});
		
		node2.select("circle")
			.style("fill", function (d) {
				return color2(d.word);
			})
			.transition().duration(3000)
			.attr("r", function (d) {
				return d.r;
			});
	
		node2.transition().duration(3000).attr("class", "node")
			.attr("transform", function (d) {
				return "translate(" + d.x + "," + d.y + ")";
			});
		
		var nodeExit = node2.exit().transition().duration(2000)
			.attr("class", "node")
			.attr("transform", function (d) {
				return "translate(" + (diameter2 - 20) + "," + d.y + ")";
			});;
		nodeExit.transition().duration(2000)
			.select("circle")
			.attr("r", 0);
		nodeExit.transition().duration(5000).remove();
	}
	
	// Returns a flattened hierarchy containing all leaf nodes under the root.
	function artistTopWords(artistName, root, nWords) {
		var topWords = [];
		
		for (var i = 0; i < root.length; i++) {
			if (root[i].artistName === artistName) {
				var artistTopWords = root[i].topWords;
				for (var j = 0; j < artistTopWords.length && j < nWords; j++) {
					topWords.push({ word: artistTopWords[j].word,
									count: artistTopWords[j].count,
									value: artistTopWords[j].count });
				}
			}		
		}
		return {children: topWords};
	}
	///////////////////////////////////////////////////////////////////////////
	</script>
	<!-- get the big data file here -->
	<script src="top100Words.js"></script>
	<script>
	
	var barHeight3 = 11,
		width3 = document.getElementById("rightCol").clientWidth;
	// remvoe the padding from the width
	width3 -= parseInt(getStyle(document.getElementById("rightCol"), "padding-right"));
	width3 -= parseInt(getStyle(document.getElementById("rightCol"), "padding-left"));
			
	var chart3 = d3.select("#rightCol").append("svg")
		.attr("width", width3);
		//.attr("class", "chart");
			
	updateAllTopWords({children:[]});
	
	// Update the bubble chart now that we've got everything else in order
	updateTopWordsArtist();
	
	function updateAllTopWords(selectTopWords) {
		var x3 = d3.scale.linear()
			.range([0, width3]);
	
		var allArtistsTopWords = allTopWordCounts(top100Words, selectTopWords);
		
		x3.domain([0, d3.max(allArtistsTopWords, function(d) { return d.value; })]);
		
		chart3.attr("height", barHeight3 * allArtistsTopWords.length);
		
		var bar3 = chart3.selectAll("g")
			.data(allArtistsTopWords)
			.style("fill", function (d) {
					if (d.highlight === 1) {
						return color2(d.word);
					} else {
						return "black";
					}
				})
			.enter().append("g")
			.attr("transform", function(d, i) { return "translate(" + (width3 - x3(d.value)) + ", " + i * barHeight3 + ")"; });
		
		bar3.append("rect")
			.attr("width", function(d) { return x3(d.value);})
			.attr("height", barHeight3 - 1);
		
		bar3.append("title")
			.text(function(d) { return d.word + ": " + d.count; });
			
		bar3.append("text")
			.attr("x", function(d) { return (3); })
			.attr("y", barHeight3 / 2)
			.attr("dy", ".35em")
			.attr("fill", "white")
			.text(function(d) { return d.word; });
	}
	
	function allTopWordCounts(allArtistsWords, selectTopWords) {
		var allWords = [];
		var idx = {};
		
		var selectWordsString = "|";
		
		selectTopWords.children.forEach(function (d) { selectWordsString += d.word + "|"; });
		
		// for each artist
		for (var i = 0; i < allArtistsWords.length; i++) {
			var artistTopWords = allArtistsWords[i].topWords;
			// for each word for that artist
			for (var j = 0; j < artistTopWords.length; j++) {
				if (idx.hasOwnProperty(artistTopWords[j].word)) {
					allWords[idx[artistTopWords[j].word]].count += artistTopWords[j].count;
					allWords[idx[artistTopWords[j].word]].value += artistTopWords[j].count;
				} else {
					var highlight = 0;
					if (selectWordsString.indexOf("|"+artistTopWords[j].word+"|") != -1) {	
						highlight = 1;
					}
					idx[artistTopWords[j].word] = allWords.length;
					allWords.push({ word: artistTopWords[j].word,
									highlight: highlight,
									count: artistTopWords[j].count,
									value: artistTopWords[j].count + 5000});
				}
			}
		}
		return allWords.sort(function (a, b) {return b.count - a.count;});
	}
	</script>
	
</body>
</html>
